// From https://github.com/timdown/rangy/blob/1e55169d2e4d1d9458c2a87119addf47a8265276/lib/rangy-classapplier.js then minified
!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("ClassApplier",["WrappedSelection"],function(s,d){var h=s.dom,r=h.DomPosition,o=h.arrayContains,e=s.util,m=e.forEach,a=e.isHostMethod(document,"createElementNS");function p(e,t){for(var n in e)if(e.hasOwnProperty(n)&&!1===t(n,e[n]))return!1;return!0}function g(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function l(e,t){return!!e&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e)}function u(e,t){return"object"==typeof e.classList?e.classList.contains(t):l("string"==typeof e.className?e.className:e.getAttribute("class"),t)}function c(e,t){if("object"==typeof e.classList)e.classList.add(t);else{var n="string"==typeof e.className,s=n?e.className:e.getAttribute("class");s?l(s,t)||(s+=" "+t):s=t,n?e.className=s:e.setAttribute("class",s)}}var N=function(){function i(e,t,n){return t&&n?" ":""}return function(e,t){if("object"==typeof e.classList)e.classList.remove(t);else{var n="string"==typeof e.className,s=n?e.className:e.getAttribute("class");s=s.replace(new RegExp("(^|\\s)"+t+"(\\s|$)"),i),n?e.className=s:e.setAttribute("class",s)}}}();function t(e){return"string"==typeof e.className?e.className:e.getAttribute("class")}function v(e){return e&&e.split(/\s+/).sort().join(" ")}function n(e){return v(t(e))}function f(e,t){return n(e)==n(t)}function y(e,t){for(var n=t.split(/\s+/),s=0,i=n.length;s<i;++s)if(!u(e,g(n[s])))return!1;return!0}function C(e,f,c,t){-1==c&&(c=f.childNodes.length);var p=e.parentNode,d=h.getNodeIndex(e);m(t,function(e){var t,n,s,i,r,o,a,l,u;n=p,s=d,i=f,r=c,o=(t=e).node,a=t.offset,u=a,(l=o)==i&&r<a&&++u,o!=n||a!=s&&a!=s+1||(l=i,u+=r-s),o==n&&s+1<a&&--u,t.node=l,t.offset=u}),f.childNodes.length==c?f.appendChild(e):f.insertBefore(e,f.childNodes[c])}function T(e,t){var i=e.parentNode,r=h.getNodeIndex(e);m(t,function(e){var t,n,s;n=i,s=r,(t=e).node==n&&t.offset>s&&--t.offset}),h.removeNode(e)}function E(e,t){return function(e,t,n,s,i){for(var r,o=[];r=e.firstChild;)C(r,t,n++,i),o.push(r);return s&&T(e,i),o}(e,e.parentNode,h.getNodeIndex(e),!0,t)}function b(e,t){var n=e.cloneRange();n.selectNodeContents(t);var s=n.intersection(e);return""!=(s?s.toString():"")}function A(e){for(var t,n=e.getNodes([3]),s=0;(t=n[s])&&!b(e,t);)++s;for(var i=n.length-1;(t=n[i])&&!b(e,t);)--i;return n.slice(s,i+1)}function S(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,s,i,r=0,o=e.attributes.length;r<o;++r)if("class"!=(i=(n=e.attributes[r]).name)){if(null===n!=(null===(s=t.attributes.getNamedItem(i))))return!1;if(n.specified!=s.specified)return!1;if(n.specified&&n.nodeValue!==s.nodeValue)return!1}return!0}function x(e,t){for(var n,s=0,i=e.attributes.length;s<i;++s)if(n=e.attributes[s].name,(!t||!o(t,n))&&e.attributes[s].specified&&"class"!=n)return!0;return!1}var R=h.getComputedStyleProperty,P="boolean"==typeof document.createElement("div").isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return!(!e||1!=e.nodeType||"false"==e.contentEditable)&&("true"==e.contentEditable||P(e.parentNode))};function w(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||P(e)&&!P(e.parentNode))}function O(e){return(P(e)||1!=e.nodeType&&P(e.parentNode))&&!w(e)}var I=/^inline(-block|-table)?$/i;function W(e){return e&&1==e.nodeType&&!I.test(R(e,"display"))}var L=/[^\r\n\t\f \u200B]/;function M(e){var t,n,s=[];for(t=0;n=e[t++];)s.push(new r(n.startContainer,n.startOffset),new r(n.endContainer,n.endOffset));return s}function H(e,t){for(var n,s,i,r=0,o=e.length;r<o;++r)n=e[r],s=t[2*r],i=t[2*r+1],n.setStartAndEnd(s.node,s.offset,i.node,i.offset)}function j(e,t,n,s){var i,r,o,a,l=0==n;if(h.isAncestorOf(t,e))return e;if(h.isCharacterDataNode(t)){var u=h.getNodeIndex(t);if(0==n)n=u;else{if(n!=t.length)throw d.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+n+" in "+t.data);n=u+1}t=t.parentNode}if(o=t,a=n,h.isCharacterDataNode(o)?0==a?o.previousSibling:a!=o.length||o.nextSibling:0<a&&a<o.childNodes.length){i=t.cloneNode(!1),r=t.parentNode,i.id&&i.removeAttribute("id");for(var f,c=0;f=t.childNodes[n];)C(f,i,c++,s);return C(i,r,h.getNodeIndex(t)+1,s),t==e?i:j(e,r,h.getNodeIndex(i),s)}if(e!=t){i=t.parentNode;var p=h.getNodeIndex(t);return l||p++,j(e,i,p,s)}return e}function $(a){var l=a?"nextSibling":"previousSibling";return function(e,t){var n,s,i=e.parentNode,r=e[l];if(r){if(r&&3==r.nodeType)return r}else if(t&&(r=i[l])&&1==r.nodeType&&(s=r,(n=i).namespaceURI==s.namespaceURI&&n.tagName.toLowerCase()==s.tagName.toLowerCase()&&f(n,s)&&S(n,s)&&"inline"==R(n,"display")&&"inline"==R(s,"display"))){var o=r[a?"firstChild":"lastChild"];if(o&&3==o.nodeType)return o}return null}}var z=$(!1),B=$(!0);function D(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}var U=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],V={};function k(e,t,n){var s,i,r,o,a=this;a.cssClass=a.className=e;var l=null,u={};if("object"==typeof t&&null!==t){for(void 0!==t.elementTagName&&(t.elementTagName=t.elementTagName.toLowerCase()),n=t.tagNames,l=t.elementProperties,u=t.elementAttributes,i=0;o=U[i++];)t.hasOwnProperty(o)&&(a[o]=t[o]);s=t.normalize}else s=t;a.normalize=void 0===s||s,a.attrExceptions=[];var f=document.createElement(a.elementTagName);a.elementProperties=a.copyPropertiesToElement(l,f,!0),p(u,function(e,t){a.attrExceptions.push(e),u[e]=""+t}),a.elementAttributes=u,a.elementSortedClassName=a.elementProperties.hasOwnProperty("className")?v(a.elementProperties.className+" "+e):e,a.applyToAnyTagName=!1;var c=typeof n;if("string"==c)"*"==n?a.applyToAnyTagName=!0:a.tagNames=g(n.toLowerCase()).split(/\s*,\s*/);else if("object"==c&&"number"==typeof n.length)for(a.tagNames=[],i=0,r=n.length;i<r;++i)"*"==n[i]?a.applyToAnyTagName=!0:a.tagNames.push(n[i].toLowerCase());else a.tagNames=[a.elementTagName]}k.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!(D.prototype={doMerge:function(e){var t=this.textNodes,s=t[0];if(1<t.length){var i,r=h.getNodeIndex(s),o=[],a=0;m(t,function(t,n){i=t.parentNode,0<n&&(i.removeChild(t),i.hasChildNodes()||h.removeNode(i),e&&m(e,function(e){e.node==t&&(e.node=s,e.offset+=a),e.node==i&&e.offset>r&&(--e.offset,e.offset==r+1&&n<len-1&&(e.node=s,e.offset=a))})),o[n]=t.data,a+=t.data.length}),s.data=o.join("")}return s.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){var n=[];return m(this.textNodes,function(e,t){n[t]="'"+e.data+"'"}),"[Merge("+n.join(",")+")]"}}),useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var s,i,r,o,a,l,u={};for(var f in e)if(e.hasOwnProperty(f))if(o=e[f],a=t[f],"className"==f)c(t,o),c(t,this.className),t[f]=v(t[f]),n&&(u[f]=o);else if("style"==f){for(s in i=a,n&&(u[f]=r={}),e[f])e[f].hasOwnProperty(s)&&(i[s]=o[s],n&&(r[s]=i[s]));this.attrExceptions.push(f)}else t[f]=o,n&&(u[f]=t[f],l=V.hasOwnProperty(f)?V[f]:f,this.attrExceptions.push(l));return n?u:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&t.setAttribute(n,e[n])},appliesToElement:function(e){return o(this.tagNames,e.tagName.toLowerCase())},getEmptyElements:function(e){var t=this;return e.getNodes([1],function(e){return t.appliesToElement(e)&&!e.hasChildNodes()})},hasClass:function(e){return 1==e.nodeType&&(this.applyToAnyTagName||this.appliesToElement(e))&&u(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||O(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&function(e){if(0==e.data.length)return!0;if(L.test(e.data))return!1;switch(R(e.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return W(e.previousSibling)||W(e.nextSibling)}(e)},postApply:function(e,t,n,s){var r,o,a=e[0],l=e[e.length-1],u=[],f=a,c=l,p=0,d=l.length;m(e,function(e){(o=z(e,!s))?(r||(r=new D(o),u.push(r)),r.textNodes.push(e),e===a&&(f=r.textNodes[0],p=f.length),e===l&&(c=r.textNodes[0],d=r.getLength())):r=null});var h=B(l,!s);if(h&&(r||(r=new D(l),u.push(r)),r.textNodes.push(h)),u.length){for(i=0,len=u.length;i<len;++i)u[i].doMerge(n);t.setStartAndEnd(f,p,c,d)}},createContainer:function(e){var t=h.getDocument(e),n=a&&!h.isHtmlNamespace(e)&&e.namespaceURI?t.createElementNS(e.namespaceURI,this.elementTagName):t.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,n,!1),this.copyAttributesToElement(this.elementAttributes,n),c(n,this.className),this.onElementCreate&&this.onElementCreate(n,this),n},elementHasProperties:function(n,e){var s=this;return p(e,function(e,t){if("className"==e)return y(n,t);if("object"==typeof t){if(!s.elementHasProperties(n[e],t))return!1}else if(n[e]!==t)return!1})},elementHasAttributes:function(n,e){return p(e,function(e,t){if(n.getAttribute(e)!==t)return!1})},applyToTextNode:function(e,t){if((r=e.parentNode)&&1==r.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(r.nodeName)){var n=e.parentNode;if(1==n.childNodes.length&&this.useExistingElements&&this.appliesToElement(n)&&this.elementHasProperties(n,this.elementProperties)&&this.elementHasAttributes(n,this.elementAttributes))c(n,this.className);else{var s=e.parentNode,i=this.createContainer(s);s.insertBefore(i,e),i.appendChild(e)}}var r},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&n(e)==this.elementSortedClassName&&this.elementHasProperties(e,this.elementProperties)&&!x(e,this.attrExceptions)&&this.elementHasAttributes(e,this.elementAttributes)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){var t=this,n=e.getNodes([1],function(e){return t.isEmptyContainer(e)}),s=[e],i=M(s);m(n,function(e){T(e,i)}),H(s,i)},undoToTextNode:function(e,t,n,s){if(!t.containsNode(n)){var i=t.cloneRange();i.selectNode(n),i.isPointInRange(t.endContainer,t.endOffset)&&(j(n,t.endContainer,t.endOffset,s),t.setEndAfter(n)),i.isPointInRange(t.startContainer,t.startOffset)&&(n=j(n,t.startContainer,t.startOffset,s))}this.isRemovable(n)?E(n,s):N(n,this.className)},splitAncestorWithClass:function(e,t,n){var s=this.getSelfOrAncestorWithClass(e);s&&j(s,e,t,n)},undoToAncestor:function(e,t){this.isRemovable(e)?E(e,t):N(e,this.className)},applyToRange:function(e,t){var n=this,s=M((t=t||[])||[]);e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e);var i=A(e);if(i.length){m(i,function(e){n.isIgnorableWhiteSpaceNode(e)||n.getSelfOrAncestorWithClass(e)||!n.isModifiable(e)||n.applyToTextNode(e,s)});var r=i[i.length-1];e.setStartAndEnd(i[0],0,r,r.length),n.normalize&&n.postApply(i,e,s,!1),H(t,s)}var o=n.getEmptyElements(e);m(o,function(e){c(e,n.className)})},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(e){var t=s.getSelection(e);t.setRanges(this.applyToRanges(t.getAllRanges()))},undoToRange:function(e,t){var n=this,s=M(t=t||[]);e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e,s);var i,r,o=A(e),a=o[o.length-1];if(o.length){n.splitAncestorWithClass(e.endContainer,e.endOffset,s),n.splitAncestorWithClass(e.startContainer,e.startOffset,s);for(var l=0,u=o.length;l<u;++l)i=o[l],(r=n.getSelfOrAncestorWithClass(i))&&n.isModifiable(i)&&n.undoToAncestor(r,s);e.setStartAndEnd(o[0],0,a,a.length),n.normalize&&n.postApply(o,e,s,!0),H(t,s)}var f=n.getEmptyElements(e);m(f,function(e){N(e,n.className)})},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(e){var t=s.getSelection(e),n=s.getSelection(e).getAllRanges();this.undoToRanges(n),t.setRanges(n)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,s=0;n=t[s++];)if(!this.isIgnorableWhiteSpaceNode(n)&&b(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(e){var t=s.getSelection(e);return this.isAppliedToRanges(t.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var n=[],s=this;return e.getNodes([3],function(e){var t=s.getSelfOrAncestorWithClass(e);t&&!o(n,t)&&n.push(t)}),n},detach:function(){}},k.util={hasClass:u,addClass:c,removeClass:N,getClass:t,hasSameClasses:f,hasAllClasses:y,replaceWithOwnChildren:E,elementsHaveSameNonClassAttributes:S,elementHasNonClassAttributes:x,splitNodeAt:j,isEditableElement:P,isEditingHost:w,isEditable:O},s.CssClassApplier=s.ClassApplier=k,s.createClassApplier=function(e,t,n){return new k(e,t,n)},e.createAliasForDeprecatedMethod(s,"createCssClassApplier","createClassApplier",d)}),e},this);
