// From https://github.com/timdown/rangy/blob/1e55169d2e4d1d9458c2a87119addf47a8265276/lib/rangy-highlighter.js then minified
!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("Highlighter",["ClassApplier"],function(T,e){var t=T.dom,i=t.arrayContains,o=t.getBody,x=T.util.createOptions,A=T.util.forEach,s=1;function n(e,t){return e.characterRange.start-t.characterRange.start}function f(e,t){return t?e.getElementById(t):o(e)}var r={};function a(e,t){this.type=e,this.converterCreator=t}function h(e,t){r[e]=new a(e,t)}function R(e){var t=r[e];if(t instanceof a)return t.create();throw new Error("Highlighter type '"+e+"' is not valid")}function H(e,t){this.start=e,this.end=t}a.prototype.create=function(){var e=this.converterCreator();return e.type=this.type,e},T.registerHighlighterType=h,H.prototype={intersects:function(e){return this.start<e.end&&this.end>e.start},isContiguousWith:function(e){return this.start==e.end||this.end==e.start},union:function(e){return new H(Math.min(this.start,e.start),Math.max(this.end,e.end))},intersection:function(e){return new H(Math.max(this.start,e.start),Math.min(this.end,e.end))},getComplements:function(e){var t=[];if(this.start>=e.start){if(this.end<=e.end)return[];t.push(new H(e.end,this.end))}else t.push(new H(this.start,Math.min(this.end,e.start))),this.end>e.end&&t.push(new H(e.end,this.end));return t},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},H.fromCharacterRange=function(e){return new H(e.start,e.end)};var c,g={rangeToCharacterRange:function(e,t){var n=e.getBookmark(t);return new H(n.start,n.end)},characterRangeToRange:function(e,t,n){var r=T.createRange(e);return r.moveToBookmark({start:t.start,end:t.end,containerNode:n}),r},serializeSelection:function(e,t){for(var n=e.getAllRanges(),r=[],i=1==n.length&&e.isBackward(),a=0,s=n.length;a<s;++a)r[a]={characterRange:this.rangeToCharacterRange(n[a],t),backward:i};return r},restoreSelection:function(e,t,n){e.removeAllRanges();for(var r,i,a=e.win.document,s=0,h=t.length;s<h;++s)(i=t[s]).characterRange,r=this.characterRangeToRange(a,i.characterRange,n),e.addRange(r,i.backward)}};function I(e,t,n,r,i,a){i?(this.id=i,s=Math.max(s,i+1)):this.id=s++,this.characterRange=t,this.doc=e,this.classApplier=n,this.converter=r,this.containerElementId=a||null,this.applied=!1}function l(e,t){t=t||"textContent",this.doc=e||document,this.classAppliers={},this.highlights=[],this.converter=R(t)}h("textContent",function(){return g}),h("TextRange",function(){if(!c){var e=T.modules.TextRange;if(!e)throw new Error("TextRange module is missing.");if(!e.supported)throw new Error("TextRange module is present but not supported.");c={rangeToCharacterRange:function(e,t){return H.fromCharacterRange(e.toCharacterRange(t))},characterRangeToRange:function(e,t,n){var r=T.createRange(e);return r.selectCharacters(n,t.start,t.end),r},serializeSelection:function(e,t){return e.saveCharacterRanges(t)},restoreSelection:function(e,t,n){e.restoreCharacterRanges(n,t)}}}return c}),I.prototype={getContainerElement:function(){return f(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(e){this.characterRange=this.converter.rangeToCharacterRange(e,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(e){return this.getRange().containsNodeContents(e.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},l.prototype={addClassApplier:function(e){this.classAppliers[e.className]=e},getHighlightForElement:function(e){for(var t=this.highlights,n=0,r=t.length;n<r;++n)if(t[n].containsElement(e))return t[n];return null},removeHighlights:function(e){for(var t,n=0,r=this.highlights.length;n<r;++n)t=this.highlights[n],i(e,t)&&(t.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(e){var n=[],r=this.highlights;return A(e,function(t){A(r,function(e){t.intersectsRange(e.getRange())&&!i(n,e)&&n.push(e)})}),n},highlightCharacterRanges:function(e,t,n){var r,i,a,s,h,o,c,g,l,u,p,d,f=this.highlights,R=this.converter,v=this.doc,m=[],C=e?this.classAppliers[e]:null,w=(n=x(n,{containerElementId:null,exclusive:!0})).containerElementId,y=n.exclusive;for(w&&(s=this.doc.getElementById(w))&&((h=T.createRange(this.doc)).selectNodeContents(s),o=new H(0,h.toString().length)),r=0,i=t.length;r<i;++r)if(c=t[r],p=[],o&&(c=c.intersection(o)),c.start!=c.end){for(a=0;a<f.length;++a)l=!1,w==f[a].containerElementId&&(g=f[a].characterRange,d=!(u=C==f[a].classApplier)&&y,(g.intersects(c)||g.isContiguousWith(c))&&(u||d)&&(d&&A(g.getComplements(c),function(e){p.push(new I(v,e,f[a].classApplier,R,null,w))}),l=!0,u&&(c=g.union(c)))),l?(m.push(f[a]),f[a]=new I(v,g.union(c),C,R,null,w)):p.push(f[a]);C&&p.push(new I(v,c,C,R,null,w)),this.highlights=f=p}A(m,function(e){e.unapply()});var E=[];return A(f,function(e){e.applied||(e.apply(),E.push(e))}),E},highlightRanges:function(e,t,n){var r,i=[],a=this.converter,s=(n=x(n,{containerElement:null,exclusive:!0})).containerElement,h=s?s.id:null;return s&&(r=T.createRange(s)).selectNodeContents(s),A(t,function(e){var t=s?r.intersection(e):e;i.push(a.rangeToCharacterRange(t,s||o(e.getDocument())))}),this.highlightCharacterRanges(e,i,{containerElementId:h,exclusive:n.exclusive})},highlightSelection:function(e,t){var n=this.converter,r=!!e&&this.classAppliers[e],i=(t=x(t,{containerElementId:null,exclusive:!0})).containerElementId,a=t.exclusive,s=t.selection||T.getSelection(this.doc),h=f(s.win.document,i);if(!r&&!1!==e)throw new Error("No class applier found for class '"+e+"'");var o=n.serializeSelection(s,h),c=[];A(o,function(e){c.push(H.fromCharacterRange(e.characterRange))});var g=this.highlightCharacterRanges(e,c,{containerElementId:i,exclusive:a});return n.restoreSelection(s,o,h),g},unhighlightSelection:function(e){e=e||T.getSelection(this.doc);var t=this.getIntersectingHighlights(e.getAllRanges());return this.removeHighlights(t),e.removeAllRanges(),t},getHighlightsInSelection:function(e){return e=e||T.getSelection(this.doc),this.getIntersectingHighlights(e.getAllRanges())},selectionOverlapsHighlight:function(e){return 0<this.getHighlightsInSelection(e).length},serialize:function(i){var e,a,s,h,o=this,t=o.highlights;return t.sort(n),e=(i=x(i,{serializeHighlightText:!1,type:o.converter.type})).type,(s=e!=o.converter.type)&&(h=R(e)),a=["type:"+e],A(t,function(e){var t,n=e.characterRange;s&&(t=e.getContainerElement(),n=h.rangeToCharacterRange(o.converter.characterRangeToRange(o.doc,n,t),t));var r=[n.start,n.end,e.id,e.classApplier.className,e.containerElementId];i.serializeHighlightText&&r.push(e.getText()),a.push(r.join("$"))}),a.join("|")},deserialize:function(e){var t,n,r,i,a,s,h,o,c=e.split("|"),g=[],l=c[0],u=!1;if(!l||!(t=/^type:(\w+)$/.exec(l)))throw new Error("Serialized highlights are invalid.");(n=t[1])!=this.converter.type&&(r=R(n),u=!0),c.shift();for(var p,d=c.length;0<d--;){if(s=new H(+(p=c[d].split("$"))[0],+p[1]),h=p[4]||null,u&&(o=f(this.doc,h),s=this.converter.rangeToCharacterRange(r.characterRangeToRange(this.doc,s,o),o)),!(i=this.classAppliers[p[3]]))throw new Error("No class applier found for class '"+p[3]+"'");(a=new I(this.doc,s,i,this.converter,parseInt(p[2]),h)).apply(),g.push(a)}this.highlights=g}},T.Highlighter=l,T.createHighlighter=function(e,t){return new l(e,t)}}),e},this);
